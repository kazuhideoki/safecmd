# SafeCmd - 安全な rm コマンドの設計仕様書

## 1. プロジェクト概要

SafeCmdは、従来の`rm`コマンドの代替として設計された安全なファイル削除ツールです。内部的に`trash`コマンドを使用することで、誤削除を防ぎ、削除したファイルの復元を可能にします。

### 現在の実装状況

- ✅ **基本機能実装済み**: ファイル・ディレクトリのゴミ箱への移動
- ✅ **`-d`フラグ**: 空ディレクトリの削除
- ✅ **`-r`フラグ**: 再帰的削除
- 🚧 **開発中**: 設定ファイル、保護機能、その他の`rm`互換フラグ

## 2. 設計思想

### 2.1 基本原則

- **安全第一**: 重要なファイルの誤削除を防ぐ
- **透過的な動作**: 通常の`rm`コマンドと同じインターフェースを提供
- **復元可能性**: 削除したファイルをゴミ箱から復元可能
- **保護機能**: システムファイルや重要なファイルの削除を制限
- **動作範囲の制限**: `safecmd.toml`で設定されたディレクトリ配下でのみ動作

### 2.2 動作モード

- **デフォルトモード**: ファイルをゴミ箱に移動
- **ドライランモード**: 削除対象のプレビュー機能

## 3. 主要機能

### 3.1 基本機能

#### rm コマンドとの完全互換性

以下の`rm`コマンドのオプションを完全にサポート：

- ✅ `-d`: 空のディレクトリのみ削除可能
- 🚧 `-f`: ファイルが存在しない場合もエラーを出さない、権限に関わらず削除
- 🚧 `-i`: 各ファイル削除前に確認（ゴミ箱への移動前に確認）
- 🚧 `-I`: 3つ以上のファイルまたは再帰的削除時に一度だけ確認
- ✅ `-R/-r`: ディレクトリを再帰的に削除
- 🚧 `-v`: 削除（ゴミ箱への移動）したファイルを表示
- 🚧 `-x`: マウントポイントを越えない
- 🚧 `-P`: 効果なし（後方互換性のため維持）
- 🚧 `-W`: 未対応（Union FS固有のため）
- 🚧 `--`: オプション終端デリミタ（`-`で始まるファイル名に対応）

その他の標準的な動作：

- 🚧 シンボリックリンクはリンク自体を削除（参照先は削除しない）
- 🚧 `/`、`.`、`..`の削除は拒否
- ✅ 複数ファイルの一括削除

### 3.2 安全機能

- 🚧 **動作範囲制限**
  - `safecmd.toml`で設定されたディレクトリ配下でのみ利用可能
  - 設定されたディレクトリ外での実行はエラーとなる

- 🚧 **保護リスト機能**
  - システムファイルの削除防止
  - `.gitignore`に記述されたファイル/ディレクトリはデフォルトで削除不可
  - `.allowsafecmd`に記述されたパターンは削除可能（`.gitignore`の記述を上書き）
  - カスタム保護リストの設定

- 🚧 **ログ機能**
  - 削除操作の履歴記録
  - 復元用メタデータの保存

### 3.3 拡張機能

- 🚧 **設定ファイル**
  - `safecmd.toml`による設定カスタマイズ

- 🚧 **除外設定**
  - `.allowsafecmd`ファイルによる削除許可リスト

## 4. 技術仕様

### 4.1 実装言語

- Rust（高速性と安全性を重視）

### 4.2 依存関係

- ✅ `trash` crate - Rustのクロスプラットフォームゴミ箱ライブラリ
- ✅ `clap` - コマンドライン引数パーサー
- ✅ 最小限の依存関係で実装

### 4.3 コマンドラインインターフェース

```bash
safecmd [OPTIONS] [FILES...]

実装済みオプション:
  -d              空のディレクトリのみ削除 ✅
  -r              ディレクトリを再帰的に削除 ✅
  --version       バージョン情報を表示 ✅
  --help          ヘルプを表示 ✅

未実装オプション:
  -f              ファイルが存在しない場合もエラーを出さない 🚧
  -i              各ファイル削除前に確認 🚧
  -I              3つ以上のファイルまたは再帰的削除時に一度だけ確認 🚧
  -R              -rのエイリアス 🚧
  -v              削除したファイルを表示 🚧
  -x              マウントポイントを越えない 🚧
  -P              効果なし（後方互換性のため） 🚧
  -n, --dry-run   実行内容のプレビュー（独自拡張） 🚧
```

### 使用例

```bash
# 空のディレクトリを削除
safecmd -d empty_dir
# ディレクトリを再帰的に削除
safecmd -r build temp
```

### 4.4 設定ファイル形式

#### プロジェクト設定 (`safecmd.toml`)

```toml
# 必須設定: safecmdが動作可能なディレクトリを指定
[scope]
allowed_directories = [
  "/Users/username/projects",
  "/tmp"
]

[protection]
system_files = true
git_ignored = true  # .gitignoreのパターンを削除不可とする
custom_patterns = [
  "*.key",
  "*.pem",
  "node_modules/**",
  ".env*"
]

[logging]
enabled = true
path = ".safecmd/logs"
```

#### 削除許可リスト (`.allowsafecmd`)

```
# .gitignoreと同じ記述方法で削除を許可するパターンを記述
# .gitignoreで保護されているファイルも、ここに記述すれば削除可能
temp/*
*.tmp
*.log
build/
dist/
node_modules/
.cache/
```

## 5. テスト戦略

- ✅ 統合テスト: `trash` crateとの連携テスト
  - ファイル削除のテスト
  - ディレクトリ削除のテスト (`-d`, `-r`)
  - エラーケースのテスト
- 🚧 ユニットテスト: 各機能の個別テスト
- 🚧 シナリオテスト: 実使用ケースのテスト
- 🚧 安全性テスト: 保護機能の動作確認
