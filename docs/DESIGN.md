# SafeCmd - 安全な rm コマンドの設計仕様書

## 1. プロジェクト概要

SafeCmdは、従来の`rm`コマンドの代替として設計された安全なファイル削除ツールです。内部的に`trash`コマンドを使用することで、誤削除を防ぎ、削除したファイルの復元を可能にします。

### 現在の実装状況

- ✅ **基本機能実装済み**: ファイル・ディレクトリのゴミ箱への移動
- ✅ **`-d`フラグ**: 空ディレクトリの削除
- ✅ **`-f`フラグ**: 強制削除、存在しないファイルを無視
- ✅ **`-r`/`-R`フラグ**: 再帰的削除
- ✅ **`config.toml`対応**: 追加許可ディレクトリ設定

## 2. 設計思想

### 2.1 基本原則

- **安全第一**: 重要なファイルの誤削除を防ぐ
- **透過的な動作**: `rm`コマンド互換のインターフェースを提供
- **復元可能性**: 削除したファイルをゴミ箱から復元可能
- **保護機能**: システムファイルや重要なファイルの削除を制限
- **動作範囲の制限**: カレントディレクトリ配下と追加許可ディレクトリ配下に操作を制限

### 2.2 動作モード

- **デフォルトモード**: ファイルをゴミ箱に移動

## 3. 主要機能

### 3.1 基本機能

#### rm コマンドとの互換性

実装済みの`rm`コマンドオプション：

- ✅ `-d`: 空のディレクトリのみ削除可能
- ✅ `-f`: ファイルが存在しない場合はエラーを出さない（ただし許可範囲外パスはエラー）
- ✅ `-r`, `-R`: ディレクトリを再帰的に削除
- ✅ 複数ファイルの一括削除

将来実装予定：

- `--dry-run`: 実際に削除せずに動作を確認

### 3.2 安全機能

#### 保護機能の優先順位

- ✅ **`config.toml` - 追加許可ディレクトリ設定（最優先）**
  - safecmdは常にカレントディレクトリ配下で実行可能
  - `additional_allowed_directories.paths` に追加許可ディレクトリを設定
  - カレント配下と追加許可以外のパス操作はエラー
  - 全ての設定に優先される最重要の安全機能
  - 配置場所: `~/.config/safecmd/config.toml`
  - 初回実行時に自動作成される

  - 許可範囲は「カレント配下 + additional_allowed_directories.paths」
  - `-f` 指定時でも許可範囲外パスは拒否される

### 3.3 拡張機能

- ✅ **保護設定ファイル**
  - `config.toml`による追加許可ディレクトリ設定

## 4. 技術仕様

### 4.1 実装言語

- Rust（高速性と安全性を重視）

### 4.2 依存関係

- ✅ `trash` crate - Rustのクロスプラットフォームゴミ箱ライブラリ
- ✅ `clap` - コマンドライン引数パーサー
- ✅ 最小限の依存関係で実装

### 4.3 コマンドラインインターフェース

```bash
rm [OPTIONS] [FILES...]

オプション:
  -d              空のディレクトリのみ削除
  -f              ファイルが存在しない場合もエラーを出さない（許可範囲外はエラー）
  -r, -R          ディレクトリを再帰的に削除
  --dry-run       実際に削除せずに動作を確認 (予定)
  --version       バージョン情報を表示
  --help          ヘルプを表示
```

### 使用例

```bash
# 空のディレクトリを削除
rm -d empty_dir
# ディレクトリを再帰的に削除
rm -r build temp
```

### 4.4 設定ファイル形式

#### 追加許可ディレクトリ設定 (`config.toml`)

```toml
# カレントディレクトリ配下は常に許可されます
# 追加で許可するディレクトリを設定
# このファイルは自動的に作成されます
# 配置場所: ~/.config/safecmd/config.toml

[additional_allowed_directories]
# 絶対パスで追加許可するディレクトリを列挙
paths = [
    # Add your additional allowed directories here
    # Example: "/home/user/shared",
    # Example: "/Users/yourname/Documents",
]
```

**実装状況**: ✅ 完了

- 設定ファイルが存在しない場合は自動作成
- 追加許可ディレクトリが未設定でもカレント配下は操作可能
- 削除対象パスがカレント配下または追加許可配下にあるかをチェック

## 5. テスト戦略

- ✅ 統合テスト: `trash` crateとの連携テスト
  - ファイル削除のテスト
  - ディレクトリ削除のテスト (`-d`, `-r`)
  - 強制削除のテスト (`-f`)
  - エラーケースのテスト
- ✅ ユニットテスト: 各機能の個別テスト
- ✅ 安全性テスト: 保護機能の動作確認
- ✅ 設定ファイルテスト: テスト実行時は自動的に制限を回避

## GNU 互換ポリシー（本件 TODO の前提）

- 削除処理は GNU `rm` と同様に「対象ごとの処理」を基本とする
- 一部失敗時は削除可能な対象の処理を継続し、終了コードは非 0 とする
- シンボリックリンクはリンク自体を削除対象とし、リンク先は削除しない
- `rm -r` でもシンボリックリンクは再帰展開しない

## TODO

### 設定ファイルのバリデーション

- [ ] 空の `paths` 配列の仕様を明文化する（`[]` は「カレント配下のみ許可」）
- [ ] `additional_allowed_directories.paths` は絶対パスのみ許可し、相対パスは設定エラーにする
- [ ] 相対パスを設定した場合のエラーメッセージと終了コードを定義する

### `rm -r` の挙動（GNU 互換）

- [ ] 事前全走査での all-or-nothing は採用しないことを明記する
- [ ] 許可範囲外を含む場合は、削除可能な対象は処理継続しつつエラーを返す仕様を明記する
- [ ] 一部成功・一部失敗時の終了コード（非 0）を明記・テストする

- （参考）`patterns` や `ignore` ベースの保護機能は現状未実装。現在の保護は許可ディレクトリ制御のみ。
