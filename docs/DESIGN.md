# SafeCmd - 安全な rm コマンドの設計仕様書

## 1. プロジェクト概要

SafeCmdは、従来の`rm`コマンドの代替として設計された安全なファイル削除ツールです。内部的に`trash`コマンドを使用することで、誤削除を防ぎ、削除したファイルの復元を可能にします。

### 現在の実装状況

- ✅ **基本機能実装済み**: ファイル・ディレクトリのゴミ箱への移動
- ✅ **`-d`フラグ**: 空ディレクトリの削除
- ✅ **`-f`フラグ**: 強制削除、存在しないファイルを無視
- ✅ **`-r`フラグ**: 再帰的削除
- ✅ **`config.toml`対応**: 実行許可ディレクトリ設定

## 2. 設計思想

### 2.1 基本原則

- **安全第一**: 重要なファイルの誤削除を防ぐ
- **透過的な動作**: 通常の`rm`コマンドと同じインターフェースを提供
- **復元可能性**: 削除したファイルをゴミ箱から復元可能
- **保護機能**: システムファイルや重要なファイルの削除を制限
- **動作範囲の制限**: 削除を禁止するファイル・ディレクトリのパターンを設定

### 2.2 動作モード

- **デフォルトモード**: ファイルをゴミ箱に移動

## 3. 主要機能

### 3.1 基本機能

#### rm コマンドとの互換性

実装済みの`rm`コマンドオプション：

- ✅ `-d`: 空のディレクトリのみ削除可能
- ✅ `-f`: ファイルが存在しない場合もエラーを出さない、権限に関わらず削除
- ✅ `-r`: ディレクトリを再帰的に削除
- ✅ 複数ファイルの一括削除

将来実装予定：

- `--dry-run`: 実際に削除せずに動作を確認

### 3.2 安全機能

#### 保護機能の優先順位

- ✅ **`config.toml` - 実行許可ディレクトリ設定（最優先）**
  - safecmdの実行を許可するディレクトリを設定
  - このファイルに定義されたディレクトリ配下でのみsafecmdを実行可能
  - 許可外ディレクトリでの実行時は即座にエラー
  - 全ての設定に優先される最重要の安全機能
  - 配置場所: `~/.config/safecmd/config.toml`
  - 初回実行時に自動作成される

  - 削除を許可するパターンを設定
  - `config.toml`で許可されたディレクトリ内でのみ有効

  - ディレクトリがignoreされている場合、その中のファイルも保護

### 3.3 拡張機能

- ✅ **保護設定ファイル**
  - `config.toml`による実行許可ディレクトリ設定

## 4. 技術仕様

### 4.1 実装言語

- Rust（高速性と安全性を重視）

### 4.2 依存関係

- ✅ `trash` crate - Rustのクロスプラットフォームゴミ箱ライブラリ
- ✅ `clap` - コマンドライン引数パーサー
- ✅ 最小限の依存関係で実装

### 4.3 コマンドラインインターフェース

```bash
safecmd [OPTIONS] [FILES...]

オプション:
  -d              空のディレクトリのみ削除
  -f              ファイルが存在しない場合もエラーを出さない
  -r              ディレクトリを再帰的に削除
  --dry-run       実際に削除せずに動作を確認 (予定)
  --version       バージョン情報を表示
  --help          ヘルプを表示
```

### 使用例

```bash
# 空のディレクトリを削除
safecmd -d empty_dir
# ディレクトリを再帰的に削除
safecmd -r build temp
```

### 4.4 設定ファイル形式

#### 実行許可ディレクトリ設定 (`config.toml`)

```toml
# safecmdの実行を許可するディレクトリを設定
# このファイルは自動的に作成されます
# 配置場所: ~/.config/safecmd/config.toml

[allowed_directories]
# 絶対パスで許可するディレクトリを列挙
paths = [
    # Add your allowed directories here
    # Example: "/home/user/projects",
    # Example: "/Users/yourname/Documents",
]
```

**実装状況**: ✅ 完了

- 設定ファイルが存在しない場合は自動作成
- 許可ディレクトリが未設定の場合はエラーメッセージを表示
- 現在のディレクトリおよび削除対象パスの両方をチェック

```
!
## 5. テスト戦略

- ✅ 統合テスト: `trash` crateとの連携テスト
  - ファイル削除のテスト
  - ディレクトリ削除のテスト (`-d`, `-r`)
  - 強制削除のテスト (`-f`)
  - エラーケースのテスト
- ✅ ユニットテスト: 各機能の個別テスト
- ✅ 安全性テスト: 保護機能の動作確認
- ✅ 設定ファイルテスト: テスト実行時は自動的に制限を回避

## 考えるべきこと

- 削除禁止ファイルが含まれていた時の挙動 -> 削除可能ファイルのみ削除 or エラーにして全て拒否

## TODO

### 設定ファイルのバリデーション

- 空のpaths配列の場合の挙動が不明確
- 相対パスが指定された場合の処理

- シンボリックの扱い決定

### 不具合

  - ディレクトリ削除前に内部のすべてのファイル・サブディレクトリの保護状態を確認

- config.tomlに指定したが削除できない。
  config.toml

```

patterns = [
# Example: "*.log",
# Example: "*.cache",
# Example: "node_modules/",
# Example: "build/",
# Example: "__pycache__/",
"workspace",
"dist/",
"node_modules/",
]

```

log

```

rm -r node_modules/

```

```
