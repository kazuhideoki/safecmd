# SafeCmd - 安全な rm コマンドの設計仕様書

## 1. プロジェクト概要

SafeCmdは、従来の`rm`コマンドの代替として設計された安全なファイル削除ツールです。内部的に`trash`コマンドを使用することで、誤削除を防ぎ、削除したファイルの復元を可能にします。

## 2. 設計思想

### 2.1 基本原則

- **安全第一**: 重要なファイルの誤削除を防ぐ
- **透過的な動作**: 通常の`rm`コマンドと同じインターフェースを提供
- **復元可能性**: 削除したファイルをゴミ箱から復元可能
- **保護機能**: システムファイルや重要なファイルの削除を制限

### 2.2 動作モード

- **デフォルトモード**: ファイルをゴミ箱に移動
- **ドライランモード**: 削除対象のプレビュー機能

## 3. 主要機能

### 3.1 基本機能

#### rm コマンドとの完全互換性

以下の`rm`コマンドのオプションを完全にサポート：

- `-d`: ディレクトリも削除対象に含める
- `-f`: ファイルが存在しない場合もエラーを出さない、権限に関わらず削除
- `-i`: 各ファイル削除前に確認（ゴミ箱への移動前に確認）
- `-I`: 3つ以上のファイルまたは再帰的削除時に一度だけ確認
- `-R/-r`: ディレクトリを再帰的に削除
- `-v`: 削除（ゴミ箱への移動）したファイルを表示
- `-x`: マウントポイントを越えない
- `-P`: 効果なし（後方互換性のため維持）
- `-W`: 未対応（Union FS固有のため）
- `--`: オプション終端デリミタ（`-`で始まるファイル名に対応）

その他の標準的な動作：
- シンボリックリンクはリンク自体を削除（参照先は削除しない）
- `/`、`.`、`..`の削除は拒否
- ワイルドカード対応
- 複数ファイルの一括削除

### 3.2 安全機能

- **保護リスト機能**
  - システムファイルの削除防止
  - `.gitignore`パターンの尊重
  - カスタム保護リストの設定

- **ログ機能**
  - 削除操作の履歴記録
  - 復元用メタデータの保存

### 3.3 拡張機能

- **設定ファイル**
  - `safecmd.toml`による設定カスタマイズ

- **除外設定**
  - `.allowsafecmd`ファイルによる削除許可リスト

## 4. 技術仕様

### 4.1 実装言語

- Rust（高速性と安全性を重視）

### 4.2 依存関係

- `trash`コマンド（macOS: `trash`、Linux: `trash-cli`）
- 標準ライブラリのみを使用（最小限の依存）

### 4.3 コマンドラインインターフェース

```bash
safecmd [OPTIONS] [FILES...]

OPTIONS:
  -d              ディレクトリも削除対象に含める
  -f              ファイルが存在しない場合もエラーを出さない
  -i              各ファイル削除前に確認
  -I              3つ以上のファイルまたは再帰的削除時に一度だけ確認
  -r, -R          ディレクトリを再帰的に削除
  -v              削除したファイルを表示
  -x              マウントポイントを越えない
  -P              効果なし（後方互換性のため）
  -n, --dry-run   実行内容のプレビュー（独自拡張）
  --version       バージョン情報を表示
  --help          ヘルプを表示
```

### 4.4 設定ファイル形式

#### プロジェクト設定 (`safecmd.toml`)
```toml
[protection]
system_files = true
git_ignored = true
custom_patterns = [
  "*.key",
  "*.pem",
  "node_modules/**",
  ".env*"
]

[logging]
enabled = true
path = ".safecmd/logs"
```

#### 削除許可リスト (`.allowsafecmd`)
```
# 削除を許可するファイルパターン（1行1パターン）
temp/*
*.tmp
*.log
build/
dist/
```

## 5. 実装計画

### フェーズ1: 基本機能
1. 基本的な`rm`互換インターフェース
2. `trash`コマンドとの統合
3. 基本的なオプション対応

### フェーズ2: 安全機能
1. 保護リストの実装
2. 確認プロンプトの実装
3. ログ機能の実装

### フェーズ3: 拡張機能
1. 設定ファイル対応
2. プロジェクト固有設定
3. 高度なパターンマッチング

## 6. テスト戦略

- ユニットテスト: 各機能の個別テスト
- 統合テスト: `trash`コマンドとの連携テスト
- シナリオテスト: 実使用ケースのテスト
- 安全性テスト: 保護機能の動作確認