# SafeCmd - 安全な rm コマンドの設計仕様書

## 1. プロジェクト概要

SafeCmdは、従来の`rm`コマンドの代替として設計された安全なファイル削除ツールです。内部的に`trash`コマンドを使用することで、誤削除を防ぎ、削除したファイルの復元を可能にします。

### 現在の実装状況

- ✅ **基本機能実装済み**: ファイル・ディレクトリのゴミ箱への移動
- ✅ **`-d`フラグ**: 空ディレクトリの削除
- ✅ **`-f`フラグ**: 強制削除、存在しないファイルを無視
- ✅ **`-r`フラグ**: 再帰的削除
- ✅ **`.gitignore`対応**: gitignoreされたファイルの削除を防止
- ✅ **`.allowsafecmd`対応**: gitignore保護を上書きする許可リスト
- ✅ **`config.toml`対応**: 実行許可ディレクトリ設定
- 🚧 **開発中**: その他の`rm`互換フラグ

## 2. 設計思想

### 2.1 基本原則

- **安全第一**: 重要なファイルの誤削除を防ぐ
- **透過的な動作**: 通常の`rm`コマンドと同じインターフェースを提供
- **復元可能性**: 削除したファイルをゴミ箱から復元可能
- **保護機能**: システムファイルや重要なファイルの削除を制限
- **動作範囲の制限**: 削除を禁止するファイル・ディレクトリのパターンを設定

### 2.2 動作モード

- **デフォルトモード**: ファイルをゴミ箱に移動
- **ドライランモード**: 削除対象のプレビュー機能

## 3. 主要機能

### 3.1 基本機能

#### rm コマンドとの完全互換性

// TODO rm のフラグのみサポートでいい。
// TODO 標準出力も全て rm と同じにする

以下の`rm`コマンドのオプションを完全にサポート：

- ✅ `-d`: 空のディレクトリのみ削除可能
- ✅ `-f`: ファイルが存在しない場合もエラーを出さない、権限に関わらず削除
- 🚧 `-i`: 各ファイル削除前に確認（ゴミ箱への移動前に確認）
- 🚧 `-I`: 3つ以上のファイルまたは再帰的削除時に一度だけ確認
- ✅ `-R/-r`: ディレクトリを再帰的に削除
- 🚧 `-v`: 削除（ゴミ箱への移動）したファイルを表示
- 🚧 `-x`: マウントポイントを越えない
- 🚧 `-P`: 効果なし（後方互換性のため維持）
- 🚧 `-W`: 未対応（Union FS固有のため）
- 🚧 `--`: オプション終端デリミタ（`-`で始まるファイル名に対応）

その他の標準的な動作：

- 🚧 シンボリックリンクはリンク自体を削除（参照先は削除しない）
- 🚧 `/`、`.`、`..`の削除は拒否
- ✅ 複数ファイルの一括削除

### 3.2 安全機能

#### 保護機能の優先順位

優先順位: `config.toml` (実行許可ディレクトリ) > `.allowsafecmd` > `.gitignore`

- ✅ **`config.toml` - 実行許可ディレクトリ設定（最優先）**
  - safecmdの実行を許可するディレクトリを設定
  - このファイルに定義されたディレクトリ配下でのみsafecmdを実行可能
  - 許可外ディレクトリでの実行時は即座にエラー
  - 全ての設定に優先される最重要の安全機能
  - 配置場所: `~/.config/safecmd/config.toml`
  - 初回実行時に自動作成される

- ✅ **`.allowsafecmd` - 削除許可リスト（第2優先）**
  - 削除を許可するパターンを設定
  - `.gitignore`で保護されているファイルも削除可能にする
  - `config.toml`で許可されたディレクトリ内でのみ有効

- ✅ **`.gitignore` - デフォルト保護（第3優先）**
  - `.gitignore`に記述されたファイル/ディレクトリはデフォルトで削除不可
  - ディレクトリがignoreされている場合、その中のファイルも保護
  - プロジェクトルートまでの全ての`.gitignore`ファイルを考慮
  - `.allowsafecmd`で上書き可能

### 3.3 拡張機能

- ✅ **保護設定ファイル**
  - `config.toml`による実行許可ディレクトリ設定
  - `.allowsafecmd`ファイルによる削除許可リスト

## 4. 技術仕様

### 4.1 実装言語

- Rust（高速性と安全性を重視）

### 4.2 依存関係

- ✅ `trash` crate - Rustのクロスプラットフォームゴミ箱ライブラリ
- ✅ `clap` - コマンドライン引数パーサー
- ✅ `ignore` crate - .gitignoreパターンマッチング
- ✅ 最小限の依存関係で実装

### 4.3 コマンドラインインターフェース

```bash
safecmd [OPTIONS] [FILES...]

実装済みオプション:
  -d              空のディレクトリのみ削除 ✅
  -f              ファイルが存在しない場合もエラーを出さない ✅
  -r              ディレクトリを再帰的に削除 ✅
  --version       バージョン情報を表示 ✅
  --help          ヘルプを表示 ✅

未実装オプション:
  -i              各ファイル削除前に確認 🚧
  -I              3つ以上のファイルまたは再帰的削除時に一度だけ確認 🚧
  -R              -rのエイリアス 🚧
  -v              削除したファイルを表示 🚧
  -x              マウントポイントを越えない 🚧
  -P              効果なし（後方互換性のため） 🚧
  -n, --dry-run   実行内容のプレビュー（独自拡張） 🚧
```

### 使用例

```bash
# 空のディレクトリを削除
safecmd -d empty_dir
# ディレクトリを再帰的に削除
safecmd -r build temp
```

### 4.4 設定ファイル形式

#### 実行許可ディレクトリ設定 (`config.toml`)

```toml
# safecmdの実行を許可するディレクトリを設定
# このファイルは自動的に作成されます
# 配置場所: ~/.config/safecmd/config.toml

[allowed_directories]
# 絶対パスで許可するディレクトリを列挙
paths = [
    # Add your allowed directories here
    # Example: "/home/user/projects",
    # Example: "/Users/yourname/Documents",
]
```

**実装状況**: ✅ 完了

- 設定ファイルが存在しない場合は自動作成
- 許可ディレクトリが未設定の場合はエラーメッセージを表示
- 現在のディレクトリおよび削除対象パスの両方をチェック

#### 削除許可リスト (`.allowsafecmd`)

```
# .gitignoreと同じ記述方法で削除を許可するパターンを記述
# .gitignoreで保護されているファイルも、ここに記述すれば削除可能
temp/*
*.tmp
*.log
build/
dist/
node_modules/
.cache/
```

## 5. テスト戦略

- ✅ 統合テスト: `trash` crateとの連携テスト
  - ファイル削除のテスト
  - ディレクトリ削除のテスト (`-d`, `-r`)
  - 強制削除のテスト (`-f`)
  - エラーケースのテスト
  - `.gitignore`保護機能のテスト
- ✅ ユニットテスト: 各機能の個別テスト
  - GitignoreCheckerの動作テスト
  - 親ディレクトリの`.gitignore`継承テスト
- 🚧 シナリオテスト: 実使用ケースのテスト
- ✅ 安全性テスト: 保護機能の動作確認
- ✅ 設定ファイルテスト: テスト実行時は自動的に制限を回避

## 考えるべきこと

- 削除禁止ファイルが含まれていた時の挙動 -> 削除可能ファイルのみ削除 or エラーにして全て拒否

## TODO

### 設定ファイルのバリデーション

- 空のpaths配列の場合の挙動が不明確
- 相対パスが指定された場合の処理

- シンボリックの扱い決定

### 不具合

- ~~ネストされた .gitignore 設定のファイルが -r で削除できてしまう。削除できないべき 例: `safecmd -r dist/some_dir`~~ (修正済み: v0.1.0)
  - `RecursiveDirectoryStrategy`に再帰的なgitignoreチェックを追加
  - ディレクトリ削除前に内部のすべてのファイル・サブディレクトリの保護状態を確認
