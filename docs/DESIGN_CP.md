# SafeCmd `cp` 設計仕様書

## 1. ドキュメント情報

- 対象コマンド: `cp`
- 最終更新日: 2026-02-08
- ステータス: Reviewing（設計レビュー中）

## 2. 目的・スコープ

### 2.1 目的

SafeCmd の `cp` は、従来の `cp` の代替として、誤上書きやデータ損失を抑える安全なコピー操作を提供する。

### 2.2 スコープ

- ファイルコピー
- ディレクトリ再帰コピー（`-R`/`-r`/`--recursive`）
- 既存ファイル上書き時の安全挙動（ゴミ箱移動後に上書き）
- カレント配下 + 追加許可ディレクトリ配下への動作制限

### 2.3 非対応・簡略化

- 複雑なケース（シンボリックリンク、特殊ファイル等）はエラーとして扱う方針
- エージェント利用を前提に、最小限機能を優先

## 3. 仕様サマリー

- デフォルトでは、コピー先が既存なら事前にゴミ箱へ移動してから上書き。
- `-f` は互換性のため受理するが、安全挙動は変えない。
- `-n` は既存通常ファイルへの上書きを抑止してスキップ。
- 複数ソース時は、失敗があっても処理継続し、失敗が1件でもあれば終了コード `1`。

## 4. オプション仕様

| オプション | 挙動 | 互換性 | ステータス |
|---|---|---|---|
| なし | 基本のファイルコピー | `cp` 互換 | ⏳ 設計中 |
| `-R`, `-r`, `--recursive` | ディレクトリを再帰的にコピー | `cp` 互換 | ✅ 設計確定 |
| `-f` | 互換性のため受理（`trash` 失敗はエラー） | `cp` 互換を安全側に調整 | ✅ 設計確定 |
| `-n` | 既存通常ファイルを上書きせずスキップ | `cp` 互換 | ✅ 設計確定 |
| `-a` | アーカイブモード（`-Rp` 相当） | `cp` 互換 | ⏳ 検討中 |
| `-p` | 属性保持（時刻・権限） | `cp` 互換 | ⏳ 検討中 |
| `-v` | 詳細表示 | `cp` 互換 | ⏳ 検討中 |
| `--dry-run` | 実コピーなしで動作確認 | SafeCmd 独自 | ⏳ 検討中 |

## 5. 安全性ルール（優先順位）

1. 許可範囲チェック（最優先）
- カレントディレクトリ配下は常に操作可能。
- `additional_allowed_directories.paths` で追加許可ディレクトリを設定。
- 許可範囲外のパス操作は当該項目をエラー扱い。
- 複数ソース時は他項目の処理を継続。

2. 上書き時の動作
- 既存ファイルの上書き時は自動的にゴミ箱へ移動（`trash` crate 使用）。
- `-f` は互換性のため受理するが、`trash` 失敗は抑制しない。
- `-n` 指定時は既存通常ファイルへの上書きを行わずスキップ。
- `-n` 指定時でも型衝突（例: ファイルコピー先が既存ディレクトリ）はエラー。

3. 複数ソース時の失敗ハンドリング
- 1件失敗しても残りソースのコピーを継続。
- 最終終了コードは、失敗が1件でもあれば `1`。

## 6. 詳細仕様（ケース別）

### 6.1 単一ソース

- `source_file target_file` 形式をサポート。

### 6.2 複数ソース

- `source_file ... target_directory` 形式をサポート。
- 一部失敗時は継続実行し、最終終了コードで失敗を通知。

### 6.3 再帰コピー

- `-R` / `-r` / `--recursive` でディレクトリを再帰コピー。

### 6.4 エラー条件

- 許可範囲外パス。
- 型衝突。
- `trash` 失敗。
- サポート外のファイル種別（設計方針によりエラー）。

## 7. 設定ファイル仕様

- `rm` と共通の `config.toml` を使用。
- 利用セクション: `[additional_allowed_directories]`
- カレント配下と追加許可ディレクトリ配下でのみ動作。

## 8. 実装状況

### 8.1 設計確定

- 許可範囲チェック（カレント配下 + 追加許可ディレクトリ）を前提とする方針
- 複数ソース時は一部失敗でも継続し、失敗があれば終了コード `1` とする方針
- 上書き時は `trash` crate を用いた安全挙動を採用する方針

### 8.2 設計中・未着手

- 実装着手はこれから（オプション単位の進捗は「4. オプション仕様」を参照）

## 9. テスト方針

- 単体テスト
- ファイルコピー機能
- 上書き関連機能
- パス検証機能
- 統合テスト
- 各種オプション組み合わせ
- エラーケース
- 大容量ファイル
- 権限関連
- 安全性テスト
- 保護機能動作
- 設定ファイル適用
- 同時実行時の安全性

## 10. 未解決課題

- [ ] 検証と実処理の間でパスが差し替わる競合（TOCTOU）への対策方針を定義する。
