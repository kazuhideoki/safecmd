# SafeCmd - 安全な cp コマンドの設計仕様書

## 1. プロジェクト概要

SafeCmdの`cp`コマンドは、従来の`cp`コマンドの代替として設計された安全なファイルコピーツールです。エージェント利用を前提とし、誤った上書きやデータ損失を防ぐ最小限の機能に絞り込んで実装します。

### 現在の実装状況

- ⏳ **基本機能設計中**: ファイル・ディレクトリのコピー
- ⏳ **上書き保護機能設計中**: 既存ファイルの上書き前確認

## 2. 設計思想

### 2.1 基本原則

- **安全第一**: 重要なファイルの誤った上書きを防ぐ
- **透過的な動作**: 通常の`cp`コマンドと同じインターフェースを提供
- **動作範囲の制限**: SafeCmdで設定された許可ディレクトリ内でのみ動作
- **最小限の機能**: エージェントが必要とする基本的な機能のみ実装

### 2.2 動作モード

- **デフォルトモード**: 標準の`cp`と同じ動作（上書き時に確認なし）
- **強制モード**: `-f`フラグで確認なし上書き
- **非上書きモード**: `-n`フラグで既存ファイルを保護

## 3. 主要機能

### 3.1 基本機能

#### 必須フラグ（エージェントが頻繁に使用）

- 🔲 **基本機能**（フラグなし）: ファイルのコピー
- 🔲 **`-R`**: ディレクトリを再帰的にコピー
- 🔲 **`-f`**: 強制的に上書き（エラーを無視）
- 🔲 **`-n`**: 既存ファイルを上書きしない（安全性確保）

#### 推奨フラグ（利便性・安全性向上）

- 🔲 **`-a`**: アーカイブモード（`-Rp`と同等、属性を保持して再帰的コピー）
- 🔲 **`-p`**: ファイルの属性を保持（タイムスタンプ、パーミッション）
- 🔲 **`-v`**: 詳細表示（デバッグ用）
- 🔲 **`--dry-run`**: 実際にコピーせずに動作を確認（SafeCmd独自）

### 3.2 安全機能

#### 保護機能の優先順位

1. **`config.toml` - 実行許可ディレクトリ設定**
   - safecmdの実行を許可するディレクトリを設定
   - `rm`コマンドと共通の設定を使用
   - 許可外ディレクトリでの実行時は即座にエラー

2. **上書き時の動作**
   - 既存ファイルの上書き時は自動的にゴミ箱へ移動（`trash` crate使用）
   - `-n`オプションで上書きを完全に禁止

### 3.3 SafeCmd独自の安全機能

- 🔲 **上書き時の自動削除**: 既存ファイルを上書きする際、元ファイルをゴミ箱へ移動
- 🔲 **設定ファイル連携**: `rm`コマンドと共通の`config.toml`で動作範囲を制限
- 🔲 **--dry-run オプション**: 実際にコピーせずに動作を確認

## 4. 技術仕様

### 4.1 実装言語

- Rust（高速性と安全性を重視）

### 4.2 依存関係

- 🔲 `clap` - コマンドライン引数パーサー
- 🔲 `trash` - ゴミ箱機能（上書き時の既存ファイル削除用）

### 4.3 コマンドラインインターフェース

```bash
usage: cp [-R] [-f | -n] [-apv] source_file target_file
       cp [-R] [-f | -n] [-apv] source_file ... target_directory

オプション（必須）:
  -R              ディレクトリを再帰的にコピー
  -f              強制的に上書き（エラーを無視）
  -n              既存ファイルを上書きしない

オプション（推奨）:
  -a              アーカイブモード（-Rpと同等）
  -p              ファイルの属性を保持
  -v              詳細表示
  --dry-run       実際にコピーせずに動作を確認
```

### 使用例

```bash
# ファイルをコピー
safecmd cp file1.txt file2.txt

# 強制的に上書き
safecmd cp -f file1.txt file2.txt

# 既存ファイルを上書きしない
safecmd cp -n file1.txt file2.txt

# ディレクトリを再帰的にコピー
safecmd cp -R src/ dest/

# アーカイブモード（属性を保持して再帰的にコピー）
safecmd cp -a project/ backup/

# 複数ファイルをディレクトリにコピー
safecmd cp *.txt documents/

# 詳細表示モード
safecmd cp -v file1.txt file2.txt

# dry-runで動作確認
safecmd cp --dry-run -R project/ backup/
```

### 4.4 設定ファイル形式

既存の`config.toml`の`allowed_directories`設定を使用し、許可されたディレクトリ内でのみ動作。

SafeCmd独自の安全機能として、ファイル上書き時は自動的に元ファイルをゴミ箱へ移動（`trash` crateを使用）。

## 5. テスト戦略

- 🔲 単体テスト
  - ファイルコピー機能
  - 上書き確認機能
  - バックアップ機能
  - パス検証機能

- 🔲 統合テスト
  - 各種オプションの組み合わせテスト
  - エラーケースのテスト
  - 大容量ファイルのコピーテスト
  - 権限関連のテスト

- 🔲 安全性テスト
  - 保護機能の動作確認
  - 設定ファイルの適用テスト
  - 同時実行時の安全性

## 6. 考えるべきこと

### エラーハンドリング

- コピー途中でエラーが発生した場合の処理
  - 部分的にコピーされたファイルの扱い
  - トランザクション的な動作の実装可能性

### パフォーマンス

- 大容量ファイルのコピー時の最適化
- メモリ使用量の制限

### シンプルな実装

- エージェント利用を前提とした最小限の機能実装
- 複雑なケース（シンボリックリンク、特殊ファイル等）はエラーとして扱う

