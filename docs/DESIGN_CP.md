# SafeCmd - 安全な cp コマンドの設計仕様書

## 1. プロジェクト概要

SafeCmdの`cp`コマンドは、従来の`cp`コマンドの代替として設計された安全なファイルコピーツールです。誤った上書きやデータ損失を防ぎ、バックアップ機能を提供することで、ユーザーの重要なファイルを保護します。

### 現在の実装状況

- ⏳ **基本機能設計中**: ファイル・ディレクトリのコピー
- ⏳ **上書き保護機能設計中**: 既存ファイルの上書き前確認

## 2. 設計思想

### 2.1 基本原則

- **安全第一**: 重要なファイルの誤った上書きを防ぐ
- **透過的な動作**: 通常の`cp`コマンドと同じインターフェースを提供
- **動作範囲の制限**: SafeCmdで設定された許可ディレクトリ内でのみ動作

### 2.2 動作モード

- **デフォルトモード**: 標準の`cp`と同じ動作（上書き時に確認なし）
- **強制モード**: `-f`フラグで確認なし上書き
- **非上書きモード**: `-n`フラグで既存ファイルを保護

## 3. 主要機能

### 3.1 基本機能

#### cp コマンドとの互換性

実装予定の`cp`コマンドオプション：

- 🔲 `-R`: ディレクトリを再帰的にコピー
- 🔲 `-H`: コマンドラインで指定されたシンボリックリンクをたどる（`-R`と併用）
- 🔲 `-L`: すべてのシンボリックリンクをたどる（`-R`と併用）
- 🔲 `-P`: シンボリックリンクをたどらない（デフォルト、`-R`と併用）
- 🔲 `-f`: 強制的に上書き（確認なし）
- 🔲 `-n`: 既存ファイルを上書きしない
- 🔲 `-a`: アーカイブモード（`-RpP`と同等）
- 🔲 `-c`: コピー時にclonefile(2)を使用（macOS）
- 🔲 `-l`: ハードリンクを作成
- 🔲 `-p`: ファイルの属性を保持（モード、所有者、タイムスタンプ）
- 🔲 `-S`: スパースファイルを作成
- 🔲 `-s`: シンボリックリンクを作成
- 🔲 `-v`: 詳細表示
- 🔲 `-X`: 拡張属性を保持
- 🔲 `-x`: 異なるファイルシステムをまたがない

SafeCmd独自オプション：

- 🔲 `--dry-run`: 実際にコピーせずに動作を確認

### 3.2 安全機能

#### 保護機能の優先順位

1. **`config.toml` - 実行許可ディレクトリ設定**
   - safecmdの実行を許可するディレクトリを設定
   - `rm`コマンドと共通の設定を使用
   - 許可外ディレクトリでの実行時は即座にエラー

2. **上書き時の動作**
   - 既存ファイルの上書き時は自動的にゴミ箱へ移動（`trash` crate使用）
   - `-n`オプションで上書きを完全に禁止

### 3.3 SafeCmd独自の安全機能

- 🔲 **上書き時の自動削除**: 既存ファイルを上書きする際、元ファイルをゴミ箱へ移動
- 🔲 **設定ファイル連携**: `rm`コマンドと共通の`config.toml`で動作範囲を制限
- 🔲 **--dry-run オプション**: 実際にコピーせずに動作を確認

## 4. 技術仕様

### 4.1 実装言語

- Rust（高速性と安全性を重視）

### 4.2 依存関係

- 🔲 `clap` - コマンドライン引数パーサー
- 🔲 `trash` - ゴミ箱機能（上書き時の既存ファイル削除用）

### 4.3 コマンドラインインターフェース

```bash
usage: cp [-R [-H | -L | -P]] [-f | -n] [-aclpSsvXx] source_file target_file
       cp [-R [-H | -L | -P]] [-f | -n] [-aclpSsvXx] source_file ... target_directory

オプション:
  -R              ディレクトリを再帰的にコピー
  -H              コマンドラインで指定されたシンボリックリンクをたどる（-Rと併用）
  -L              すべてのシンボリックリンクをたどる（-Rと併用）
  -P              シンボリックリンクをたどらない（デフォルト、-Rと併用）
  -f              強制的に上書き
  -n              既存ファイルを上書きしない
  -a              アーカイブモード（-RpPと同等）
  -c              clonefile(2)を使用（macOS）
  -l              ハードリンクを作成
  -p              ファイルの属性を保持
  -S              スパースファイルを作成
  -s              シンボリックリンクを作成
  -v              詳細表示
  -X              拡張属性を保持
  -x              異なるファイルシステムをまたがない
  --dry-run       実際にコピーせずに動作を確認
```

### 使用例

```bash
# ファイルをコピー
safecmd cp file1.txt file2.txt

# 強制的に上書き
safecmd cp -f file1.txt file2.txt

# 既存ファイルを上書きしない
safecmd cp -n file1.txt file2.txt

# ディレクトリを再帰的にコピー
safecmd cp -R src/ dest/

# アーカイブモード（属性を保持して再帰的にコピー）
safecmd cp -a project/ backup/

# 複数ファイルをディレクトリにコピー
safecmd cp *.txt documents/

# シンボリックリンクを作成
safecmd cp -s original.txt link.txt

# ハードリンクを作成
safecmd cp -l original.txt hardlink.txt

# dry-runで動作確認
safecmd cp --dry-run -R project/ backup/
```

### 4.4 設定ファイル形式

既存の`config.toml`の`allowed_directories`設定を使用し、許可されたディレクトリ内でのみ動作。

SafeCmd独自の安全機能として、ファイル上書き時は自動的に元ファイルをゴミ箱へ移動（`trash` crateを使用）。

## 5. テスト戦略

- 🔲 単体テスト
  - ファイルコピー機能
  - 上書き確認機能
  - バックアップ機能
  - パス検証機能

- 🔲 統合テスト
  - 各種オプションの組み合わせテスト
  - エラーケースのテスト
  - 大容量ファイルのコピーテスト
  - 権限関連のテスト

- 🔲 安全性テスト
  - 保護機能の動作確認
  - 設定ファイルの適用テスト
  - 同時実行時の安全性

## 6. 考えるべきこと

### エラーハンドリング

- コピー途中でエラーが発生した場合の処理
  - 部分的にコピーされたファイルの扱い
  - トランザクション的な動作の実装可能性

### パフォーマンス

- 大容量ファイルのコピー時の最適化
- メモリ使用量の制限
- ネットワークドライブへのコピー対応

### 互換性

- シンボリックリンクの扱い
- ハードリンクの扱い
- 特殊ファイル（デバイスファイル、FIFOなど）の扱い

