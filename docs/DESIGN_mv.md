# SafeCmd `mv` 設計仕様書

## 1. ドキュメント情報

- 対象コマンド: `mv`
- 最終更新日: 2026-02-08
- ステータス: Implemented（基本実装完了 / 一部機能は未実装）

## 2. 目的・スコープ

### 2.1 目的

SafeCmd の `mv` は、GNU `mv` 互換の基本挙動を維持しつつ、上書きで失われるデータを `trash` へ退避することで安全性を高める。

### 2.2 スコープ

- 単一/複数ソースの移動（GNU `mv` 互換の引数解釈）
- 既存ターゲット上書き時の安全挙動（`trash` 退避）
- 同一ファイルシステム内の `rename` と、クロスファイルシステム時のフォールバック
- カレント配下 + 追加許可ディレクトリ配下への動作制限

### 2.3 非対応・簡略化

- `--backup`、`--strip-trailing-slashes`、`--context` などの GNU 拡張オプションは初期スコープ外
- 対話入力が必要な `-i` は初期スコープ外
- シンボリックリンク移動のうち、`EXDEV` 発生時のリンク属性保持は未確定（「10. 未解決課題」参照）

## 3. 仕様サマリー

- 既存ターゲットへの上書きが必要な場合のみ `trash` を使用する。
- `mv` の本来動作（ソースを最終配置先へ移動）を優先し、ソース自体は成功時に `trash` へ送らない。
- `-n` 指定時は既存ターゲットをスキップし、`trash` は呼び出さない。
- `-f` は GNU 互換のため受理するが、安全挙動は変えない（`trash` 失敗はエラー）。
- 複数ソースでは `cp`/`rm` と同様に処理継続し、1件でも失敗があれば終了コード `1`。
- 現在は `rename` ベースの基本実装まで対応し、`EXDEV` フォールバックは未実装。

## 4. オプション仕様

| オプション | 挙動 | 互換性 | ステータス |
|---|---|---|---|
| なし | 基本の移動（`rename` 優先） | GNU `mv` 互換（基本） | ✅ 基本実装済み |
| `-f` | 互換性のため受理（`trash` 失敗はエラー） | GNU 互換を安全側に調整 | ✅ 実装済み（挙動変更なし） |
| `-n` | 既存ターゲットがあれば上書きせずスキップ | GNU `mv` 互換（基本） | ✅ 実装済み |
| `-i` | 対話確認 | GNU `mv` 互換 | ❌ 初期スコープ外（未実装） |
| `-t` | ターゲットディレクトリ指定 | GNU `mv` 互換 | ⏳ 検討中 / ❌ 未実装 |
| `-T` | ディレクトリ解釈を無効化し通常ファイルとして扱う | GNU `mv` 互換 | ⏳ 検討中 / ❌ 未実装 |
| `-v` | 詳細表示 | GNU `mv` 互換 | ⏳ 検討中 / ❌ 未実装 |
| `--dry-run` | 実移動なしで動作確認 | SafeCmd 独自 | ⏳ 検討中 / ❌ 未実装 |

## 5. 安全性ルール（優先順位）

1. 許可範囲チェック（最優先）
- `rm`/`cp` と同様に、ソースとターゲットを `is_path_allowed` で検証する。
- カレント配下は常に許可、`additional_allowed_directories.paths` は追加許可とする。
- 許可範囲外パスは `-f` 指定時でも拒否する。

2. GNU 互換の移動判定
- 複数ソース時の最終引数はディレクトリ必須とする（`cp` と同じエラー方針）。
- ターゲットが既存ディレクトリの場合は `basename(source)` を連結した最終パスへ移動する。
- ソースがディレクトリで、移動先に同名の既存非空ディレクトリがある場合は GNU と同様にエラー扱いにする。

3. `trash` 整合性ルール（GNU 互換 + 実現可能性）
- `trash` は「上書きで失われる既存ターゲット」の退避にのみ使う。
- 既存通常ファイル/シンボリックリンクを上書きするケースは、移動前に `trash` へ退避する。
- 既存ディレクトリに対しては GNU 挙動を優先し、安易に `trash` へ退避して上書きしない。
- `-n` 指定時は上書き処理自体を行わないため `trash` は呼ばない。
- `trash` 失敗時は当該項目をエラーにし、`-f` でも抑制しない。

4. 複数ソース時の失敗ハンドリング
- 1件失敗しても残りソースの処理を継続する。
- 最終終了コードは、失敗が1件でもあれば `1`。

## 6. 詳細仕様（ケース別）

### 6.1 単一ソース

- `source target` を受理する。
- 既存ターゲットありかつ `-n` なしの場合のみ `trash` 退避を検討する。
- 同一ファイルシステムでは `std::fs::rename` を優先する。

### 6.2 複数ソース

- `source ... target_directory` を受理する。
- ソースごとに `target_directory/basename(source)` を最終移動先に解決する。
- 一部失敗時は処理継続し、最終終了コード `1` を返す。

### 6.3 上書き・型衝突

- 既存通常ファイル/シンボリックリンクへの上書きは `trash` 退避後に移動を試行する。
- ファイルを既存ディレクトリへ直接上書きするケースはエラー。
- ディレクトリを既存非空ディレクトリへ直接置換するケースはエラー。

### 6.4 クロスファイルシステム（`EXDEV`）フォールバック

- `rename` が `EXDEV` の場合、現時点ではフォールバック未実装のためエラーを返す。
- 将来的には `cp` と同等のコピー処理 + ソース削除へフォールバックする計画。

### 6.5 エラー条件

- 許可範囲外パス。
- ソース未存在。
- 型衝突（ファイル/ディレクトリ不整合）。
- `trash` 失敗。
- フォールバック中のコピー/削除失敗。

## 7. 設定ファイル仕様

- `rm`/`cp` と共通の `~/.config/safecmd/config.toml` を利用する。
- 利用セクション: `[additional_allowed_directories]`
- 判定ポリシーは既存実装（`Config::is_path_allowed`）に統一する。

## 8. 実装状況

### 8.1 実装済み（基本）

- 許可範囲チェックを `rm`/`cp` と同一ポリシーで実施
- 複数ソース時は一部失敗でも継続し、失敗があれば終了コード `1`
- `trash` は「上書きで消える既存ターゲット」のみに適用
- `rename` 優先の移動処理
- 既存ターゲット + `-n` でスキップ
- `-f` 受理（安全挙動は変更しない）

### 8.2 実装着手状況

- `mv` コマンド本体（基本移動 + 上書き時 `trash` + `-n`）は実装済み
- 統合テスト（単一移動 / 上書き時 `trash` / `-n` スキップ）は実装済み
- `EXDEV` フォールバックは未実装
- `-t`/`-T`/`-v`/`--dry-run` の採否と優先度は未確定

## 9. テスト方針

- 単体テスト
- 引数解釈（単一/複数ソース）
- 最終ターゲット解決
- 上書き判定と `-n` スキップ
- `EXDEV` フォールバック分岐
- 統合テスト
- ファイル移動
- ディレクトリ移動
- 複数ソース移動（部分失敗継続）
- 許可範囲外拒否
- `trash` 連携（GUI 非対応環境は既存 `cp` テスト同様にスキップ許容）

## 10. 未解決課題

- [ ] `rename` 失敗後のロールバック方針（`trash` 済みターゲットの復元可能性）をどう定義するか。
- [ ] `EXDEV` 時のシンボリックリンク移動を GNU 互換で扱うための実装詳細を詰める。
- [ ] 検証と実処理の間でパスが差し替わる競合（TOCTOU）対策をどこまで行うかを定義する。
