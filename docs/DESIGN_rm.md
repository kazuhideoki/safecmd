# SafeCmd `rm` 設計仕様書

## 1. ドキュメント情報

- 対象コマンド: `rm`
- 最終更新日: 2026-02-08
- ステータス: Accepted（実装反映済み）

## 2. 目的・スコープ

### 2.1 目的

SafeCmd の `rm` は、従来の `rm` 互換の操作感を維持しつつ、削除対象をゴミ箱へ移動することで誤削除のリスクを下げる。

### 2.2 スコープ

- ファイル・ディレクトリの削除（実体はゴミ箱移動）
- カレントディレクトリ配下と追加許可ディレクトリ配下のみを操作対象とする制限
- `rm` で日常的に使う主要オプションの互換

### 2.3 非対応

- 未実装オプションは「4. オプション仕様」を参照。

## 3. 仕様サマリー

- デフォルト動作はゴミ箱移動。
- 操作可能範囲は「カレント配下 + `config.toml` の追加許可ディレクトリ配下」。
- `-f` 指定時でも許可範囲外のパスは拒否する。
- 複数パス指定時の削除をサポートする。

## 4. オプション仕様

| オプション | 挙動 | 互換性 | ステータス |
|---|---|---|---|
| `-d` | 空ディレクトリのみ削除可能 | `rm` 互換 | ✅ 実装済み |
| `-f` | 存在しないファイルのエラーを抑制（ただし許可範囲外はエラー） | `rm` 互換を一部調整 | ✅ 実装済み |
| `-r`, `-R` | ディレクトリを再帰的に削除 | `rm` 互換 | ✅ 実装済み |
| `--dry-run` | 実際に削除せずに動作確認 | SafeCmd 独自 | ⏳ 設計済み・未実装 |

## 5. 安全性ルール（優先順位）

1. 許可範囲チェック（最優先）
- カレントディレクトリ配下は常に許可。
- `additional_allowed_directories.paths` に追加許可ディレクトリを設定可能。
- カレント配下と追加許可以外はエラー。
- `-f` 指定時でも許可範囲外は拒否。

2. 削除方式
- 許可範囲内の対象は `trash` crate を通してゴミ箱へ移動する。

## 6. 詳細仕様（ケース別）

### 6.1 単一/複数対象

- 単一対象の削除をサポート。
- 複数対象の一括削除をサポート。

### 6.2 ディレクトリ削除

- `-d`: 空ディレクトリのみ許可。
- `-r`/`-R`: 再帰削除を許可。

### 6.3 エラー条件

- 許可範囲外パスの指定。
- `-d` で空でないディレクトリを指定。
- その他 `trash` 実行時の失敗。

## 7. 設定ファイル仕様

- 設定ファイル: `~/.config/safecmd/config.toml`
- 初回実行時に自動作成。
- 利用セクション: `[additional_allowed_directories]`

```toml
# カレントディレクトリ配下は常に許可されます
# 追加で許可するディレクトリを設定
# このファイルは自動的に作成されます
# 配置場所: ~/.config/safecmd/config.toml

[additional_allowed_directories]
# 絶対パスで追加許可するディレクトリを列挙
paths = [
    # Add your additional allowed directories here
    # Example: "/home/user/shared",
    # Example: "/Users/yourname/Documents",
]
```

## 8. 実装状況

### 8.1 完了

- `trash` crate による削除対象のゴミ箱移動
- 許可範囲チェック（カレント配下 + 追加許可ディレクトリ）
- `config.toml` の自動作成と読み込み

## 9. テスト方針

- 統合テスト（`trash` crate 連携）
- ファイル削除テスト
- ディレクトリ削除テスト（`-d`, `-r`）
- 強制削除テスト（`-f`）
- エラーケーステスト
- ユニットテスト（各機能の個別検証）
- 安全性テスト（保護機能の動作確認）
- 設定ファイルテスト（テスト実行時は自動的に制限を回避）

## 10. 未解決課題

- 現時点で重大な未解決課題なし。
